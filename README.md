# boss-ansible-role-rsyslogd
ansible role to configure rsyslogd

* https://docs.debops.org/en/master/ansible/roles/debops.rsyslog/getting-started.html
* https://docs.debops.org/en/master/search.html?q=rsyslog__host_allow&check_keywords=yes&area=default#
* https://docs.debops.org/en/master/ansible/roles/debops.rsyslog/defaults-detailed.html#rsyslog-forward
* https://docs.debops.org/en/master/ansible/roles/debops.rsyslog/defaults.html?highlight=send_over_tls_only
* https://devops.profitbricks.com/tutorials/configure-remote-logging-with-rsyslog/
* Syslog configuration for remote logservers for syslog-ng and rsyslog, both client and server - https://raymii.org/s/tutorials/Syslog_config_for_remote_logservers_for_syslog-ng_and_rsyslog_client_server.html
* https://rsyslog.readthedocs.io/en/latest/search.html?q=imptcp&check_keywords=yes&area=default
* https://rsyslog.readthedocs.io/en/latest/configuration/modules/imptcp.html?highlight=imptcp
* https://rsyslog.readthedocs.io/en/latest/examples/high_performance.html?highlight=imptcp
* https://rsyslog.readthedocs.io/en/latest/concepts/multi_ruleset.html?highlight=imptcp
* https://rsyslog.readthedocs.io/en/latest/configuration/modules/idx_input.html?highlight=imptcp
* https://manpages.ubuntu.com/manpages/xenial/man5/rsyslog.conf.5.html
* https://manpages.ubuntu.com/manpages/xenial/man8/rsyslogd.8.html

# rsyslog.conf

```
# Config generated by Chef - manual edits will be overwritten
#
#  /etc/rsyslog.conf  Configuration file for rsyslog.
#
#     For more information see
#     /usr/share/doc/rsyslog-doc/html/rsyslog_conf.html
#
#  Default logging rules can be found in /etc/rsyslog.d/50-default.conf
#
# Set hostname
#
#
# Set max message size
#
$MaxMessageSize 2k

#
# Preserve FQDN
#
$PreserveFQDN off

#################
#### MODULES ####
#################

$ModLoad imuxsock
$ModLoad imklog

  $ModLoad imtcp
  $InputTCPServerRun 514

###########################
#### GLOBAL DIRECTIVES ####
###########################

#
# Use traditional timestamp format.
# To enable high precision timestamps, comment out the following line.
#
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

# Filter duplicated messages
$RepeatedMsgReduction on

#
# Set temporary directory to buffer syslog queue
#
$WorkDirectory /var/spool/rsyslog

#
# Set the default permissions for all log files.
#
$Umask 0022
$FileOwner syslog
$FileGroup adm
$FileCreateMode 0640
$DirOwner root
$DirGroup adm
$DirCreateMode 0755

$PrivDropToUser syslog
$PrivDropToGroup syslog

#
# Set other directives
#

#
# Include all config files in /etc/rsyslog.d/
#
$IncludeConfig /etc/rsyslog.d/*.conf
```



## 35-server-per-host.conf

```
root@dokken:/etc/rsyslog.d# cat 35-server-per-host.conf
# Generated by Chef
# Local modifications will be overwritten

$DirGroup adm
$DirCreateMode 0755
$FileGroup adm

$template PerHostAuth,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/auth.log"
$template PerHostCron,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/cron.log"
$template PerHostSyslog,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/syslog"
$template PerHostDaemon,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/daemon.log"
$template PerHostKern,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/kern.log"
$template PerHostLpr,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/lpr.log"
$template PerHostUser,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/user.log"
$template PerHostMail,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/mail.log"
$template PerHostMailInfo,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/mail.info"
$template PerHostMailWarn,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/mail.warn"
$template PerHostMailErr,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/mail.err"
$template PerHostNewsCrit,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/news.crit"
$template PerHostNewsErr,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/news.err"
$template PerHostNewsNotice,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/news.notice"
$template PerHostDebug,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/debug"
$template PerHostMessages,"/srv/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%HOSTNAME%/messages"

auth,authpriv.*         ?PerHostAuth
*.*;auth,authpriv.none  -?PerHostSyslog
cron.*                  ?PerHostCron
daemon.*                -?PerHostDaemon
kern.*                  -?PerHostKern
lpr.*                   -?PerHostLpr
mail.*                  -?PerHostMail
user.*                  -?PerHostUser

mail.info               -?PerHostMailInfo
mail.warn               ?PerHostMailWarn
mail.err                ?PerHostMailErr

news.crit               ?PerHostNewsCrit
news.err                ?PerHostNewsErr
news.notice             -?PerHostNewsNotice

*.=debug;\
  auth,authpriv.none;\
  news.none;mail.none   -?PerHostDebug

*.=info;*.=notice;*.=warn;\
  auth,authpriv.none;\
  cron,daemon.none;\
  mail,news.none        -?PerHostMessages


#
# Stop processing of all non-local messages. You can process remote messages
# on levels less than 35.
#
:fromhost-ip,!isequal,"127.0.0.1" stop
root@dokken:/etc/rsyslog.d#
```


## 50-default.conf

```
root@dokken:/etc/rsyslog.d# cat 50-default.conf
# Generated by Chef
# For more information see rsyslog.conf(5) and /etc/rsyslog.conf

auth,authpriv.*    /var/log/auth.log
*.*;auth,authpriv.none    -/var/log/syslog
daemon.*    -/var/log/daemon.log
kern.*    -/var/log/kern.log
mail.*    -/var/log/mail.log
user.*    -/var/log/user.log
mail.info    -/var/log/mail.info
mail.warn    -/var/log/mail.warn
mail.err    /var/log/mail.err
news.crit    /var/log/news/news.crit
news.err    /var/log/news/news.err
news.notice    -/var/log/news/news.notice
*.=debug;auth,authpriv.none;news.none;mail.none    -/var/log/debug
*.=info;*.=notice;*.=warn;auth,authpriv.none;cron,daemon.none;mail,news.none    -/var/log/messages
*.emerg    :omusrmsg:*
root@dokken:/etc/rsyslog.d#
```


# rsyslog import modules

https://rsyslog.readthedocs.io/en/latest/configuration/modules/idx_input.html?highlight=imptcp

```
im3195: RFC3195 Input Module
imfile: Text File Input Module
imgssapi: GSSAPI Syslog Input Module
imjournal: Systemd Journal Input Module
imklog: Kernel Log Input Module
imkmsg: /dev/kmsg Log Input Module
impstats: Generate Periodic Statistics of Internal Counters
imptcp: Plain TCP Syslog
imrelp: RELP Input Module
imsolaris: Solaris Input Module
imtcp: TCP Syslog Input Module
imudp: UDP Syslog Input Module
imuxsock: Unix Socket Input
```


```
# - comment: 'Log messages in journald using module imjournal'
#   options: |-
#     $ModLoad imjournal
#     $OmitLocalLogging off
#     $SystemLogSocketName /run/systemd/journal/syslog
#
```

# Debugging omfwd
https://rsyslog.adiscon.narkive.com/mwXPtC5t/rsyslog-8-4-2-dropping-first-message-when-reconnecting-with-omfwd
```
ruleset(name="customerstreamserver") {
#ignore template stuff
action(type="omfwd"
name="customerstreamserver"
target="localhost"
port="5544"
protocol="tcp"
template="LongTagForwardFormat"
queue.filename="customerstreamserver"
queue.maxdiskspace="2147483648"
queue.saveonshutdown="on"
queue.type="LinkedList"
queue.size="4000000"
queue.highwatermark="1000000"
queue.lowwatermark="900000"
queue.discardmark="3600000"
queue.discardseverity="4"
queue.timeoutenqueue="0"
action.resumeretrycount="-1"
action.resumeinterval="1"
action.reportSuspension="on"
action.reportSuspensionContinuation="on"
)
stop
}
input(type="imudp" port="1514" ruleset="customerstreamserver")
input(type="imtcp" port="1514" ruleset="customerstreamserver")
```


# Ubuntu bleeding edge

SOURCE: https://github.com/rsyslog/rsyslog-pkg-ubuntu


rsyslog-pkg-ubuntu
==================

This respository contains the sources needed to build Ubuntu rsyslog
packages. It is our goal to create the best possible packages for
the current releases of this platform.

Packages are available as PPAs.
See: http://www.rsyslog.com/ubuntu-repository/

Contributors and co-maintainers are welcome.

Script descriptions are in [INSTALL](INSTALL.md).

Project Goals
-------------

- provide excellent packages via PPAs in a timely manner
- provide scripts to be used by others who do build on their own
- learn how to collaborate on package development
- gain experience

This project is currently kind of a pilot project for other collaboration
and packaging efforts. Among others, we would like to build packages for
other platforms. We also want to create a better (and easier to manage)
extended testbench system. We will consider Buildbot and SuSE OBS at a
later stage. But before going into this larger projects, we want to gain
experience in this packaging project.

PPA Structure
-------------
We intend to maintain two different sets of PPAs:

1. regular release builds (v8-stable)
2. daily builds (v8-devel)

The regular release builds are just that: for each release, we want
to create packages for all current Ubuntu platforms very close to the
rsyslog release.

In order to facilitate "leading edge users" daily builds shall
provide the most current available rsyslog software. They base on
the project's git master branch. They will be built automatically
once a day if there has been change since the previous build.

All other branches are explicitely to be considered experimental and
are not to be used for productive environments.

Packages Provided
-----------------
Packages are to be provided for the full rsyslog infrastructure. This
includes libraries tightly coupled into the rsyslog infrastructure and
essentially maintained by the same team. Examples for these are librelp
and liblognorm.

We try to avoid providing unrelated softwares, even if that means we
cannot package some of rsyslog's functionality. The main driving force
behind this is that by providing packages, we also take responsibility
for security issues in them and so we have an additional burden of
monitoring this "external" software. As such, we can grant and exception
of the general rule if and only if a member of such third-party software
is also a member of rsyslog's release team AND commits to keeping the
packages current.

Currently available
-------------------
Supporting libraries:
- libfastjson
- liblogging
- liblognorm
- librelp

Sub-packages for rsyslog to provide specific functionality:
- rsyslog (base package, always needed)
- rsyslog-doc
- rsyslog-elasticsearch
- rsyslog-imptcp
- rsyslog-kafka (>=14.04)
- rsyslog-mmanon
- rsyslog-mmfields
- rsyslog-mmjsonparse
- rsyslog-mmnormalize
- rsyslog-mmrm1stspace
- rsyslog-mmutf8fix
- rsyslog-mongodb (>=16.04)
- rsyslog-mysql
- rsyslog-pgsql
- rsyslog-relp
- rsyslog-utils

How to install
--------------

1. Open a Terminal
2. Enter the following command:
```
sudo add-apt-repository ppa:adiscon/v8-stable
```
3. Then update your apt cache:
```
sudo apt-get update
```
4. Finally install the new rsyslog version:
```
sudo apt-get install rsyslog
```


# Client config example, TCP

#### Configure Logging Client

Next log into the rsyslog client host sending the logs and create a /etc/rsyslog.d/loghost.conf file with the following line. Replace loghost in the example with a resolvable hostname or IP address of remote logging server.

`*.* @@loghost:514`

Here is a breakdown of the above remote logging syntax:

* *.* - Matches all logging facilities and priorities.
* @@ - Specifies that TCP is used for transferring the logs while a single @ will use UDP.
* localhost - A resolvable hostname or IP address of the destination log host.
* 514 - The TCP port of the destination log host.

Note: The rsyslog server firewall rule will need to be adjusted if using UDP for transferring the log data.
